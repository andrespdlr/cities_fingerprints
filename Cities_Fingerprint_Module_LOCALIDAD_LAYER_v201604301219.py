##############################
#   **Cities Fingerprint**   #
#      MODULE_LOC_LAYER		 #                                                  
#                            #
#  codename: k1 			 #
#                            #
#   version = 201604301219   #
#    Issues known: none      #
#                            #
#   A script by AndresPDLR   #
##############################

# Requirements -----------------------------------------------------------------
import processing
import os
from PyQt4.QtCore import *
from PyQt4.QtGui import *
from qgis.core import *
from qgis.gui import *
from qgis.networkanalysis import *

edo_codes = {'01':  'ags', '02':  'bc', '03':  'bcs', '04':  'camp',
			 '05': 'coah', '06': 'col', '07': 'chis', '08':  'chih',
			 '09':   'df', '10': 'dgo', '11':  'gto', '12':   'gro',
			 '13':  'hgo', '14': 'jal', '15':  'mex', '16':  'mich',
			 '17':  'mor', '18': 'nay', '19':   'nl', '20':   'oax',
			 '21':  'pue', '22': 'qro', '23': 'qroo', '24':   'slp',
			 '25':  'sin', '26': 'son', '27':  'tab', '28': 'tamps',
			 '29': 'tlax', '30': 'ver', '31':  'yuc', '32':   'zac'}

edos = ["ags", "bc", "bcs",  "camp", "coah", "col", "chis", "chih",
        "df" , "dgo", "gro",   "gto",  "hgo", "jal",  "mex", "mich",
        "mor", "nay",  "nl",   "oax",  "pue", "qro", "qroo",  "slp",
        "sin", "son", "tab", "tamps", "tlax", "ver",  "yuc",  "zac"]

localidades_100k_dictionary = {"090070001": 1815786, "150330001": 1655015, "140390001": 1495182, "211140001": 1434062,
                               "080370001": 1321004, "020040001": 1300983, "110200001": 1238962, "090050001": 1185772,
                               "141200001": 1142483, "190390001": 1135512, "150580001": 1104585, "080190001":  809232,
                               "150570001":  792211, "310500001":  777615, "090100001":  726664, "240280001":  722772,
                               "010010001":  722250, "260300001":  715061, "050300001":  709671, "020020001":  689775,
                               "250060001":  675773, "190260001":  673616, "120010001":  673479, "151040001":  653410,
                               "230050001":  628306, "220140001":  626495, "090030001":  620416, "150310001":  612383,
                               "050350001":  608836, "160530001":  597511, "280320001":  589466, "140980001":  575942,
                               "090120001":  574577, "071010001":  537102, "090150001":  531831, "100050001":  518709,
                               "151060001":  489333, "150130001":  489160, "151210001":  484573, "190060001":  467157,
                               "280220001":  449815, "190460001":  443273, "090170001":  430978, "301930001":  428323,
                               "300870001":  424755, "090020001":  414711, "141010001":  408759, "090130001":  407885,
                               "090140001":  385439, "090060001":  384326, "250120001":  381583, "110170001":  380941,
                               "280270001":  373725, "090160001":  372889, "151220001":  356352, "270040001":  353577,
                               "190210001":  352444, "110070001":  340387, "170070001":  338650, "180170001":  332863,
                               "150390001":  322271, "280410001":  305155, "090110001":  305076, "260180001":  298625,
                               "280380001":  297284, "150600001":  281799, "020010001":  279765, "150200001":  277959,
                               "190480001":  268347, "161020001":  264439, "100070001":  257352, "250010001":  256613,
                               "130480001":  256584, "200670001":  255029, "240350001":  255015, "211560001":  248716,
                               "150810019":  242272, "090080001":  238431, "300390001":  235983, "040020001":  220389,
                               "050180001":  215271, "030030001":  215178, "260430001":  212533, "151090003":  206081,
                               "140670001":  203342, "070890001":  202672, "280090001":  197216, "120290001":  187251,
                               "301310001":  185242, "150290001":  172919, "040030001":  169466, "150250001":  168720,
                               "170110001":  162427, "090040001":  160491, "110270001":  160169, "260550001":  158089,
                               "070780001":  158027, "151090025":  156191, "170060001":  154358, "190310001":  151893,
                               "230040001":  151243, "050250001":  150178, "230080001":  149923, "161080001":  141627,
                               "300440001":  140896, "220160001":  138878, "060020001":  137383, "050020001":  134233,
                               "060070001":  130035, "320560001":  129011, "300280037":  126507, "240130001":  124644,
                               "320170001":  124623, "190190001":  122627, "150370071":  121470, "320100001":  120944,
                               "301180001":  120844, "280030122":  118614, "120350001":  118468, "080210001":  118071,
                               "060100001":  117600, "080170001":  114007, "260420001":  113836, "260290001":  113082,
                               "301080001":  112046, "150240001":  108449, "150990001":  105165, "080320001":  104836,
                               "150020015":  102667, "130770001":  102406, "201840001":  101810}

def localidad_layer(localidad, tipo):
    '''
    >> Creates a layer given a localidad
    
    Inputs:
        - localidad geocode (str)
        - tipo: type of layer
        
    Outputs:
        - a new layer
    '''
    edo = edo_codes[localidad[0:2]]
    path = 'C:/Users/Andres/geo_mex_2015/{}/{}'
    edo_layer = iface.addVectorLayer(path.format(edo, edo) + '_{}.shp'.format(tipo), '{}_{}'.format(edo, tipo), "ogr")
    filter_localidad = edo_layer.getFeatures(QgsFeatureRequest().setFilterExpression ( ' CVEGEO_LOC = ' + localidad ))
    edo_layer.setSelectedFeatures([f.id() for f in filter_localidad])
    QgsVectorFileWriter.writeAsVectorFormat(edo_layer,
                                            path.format(edo, localidad) + '_{}.shp'.format(tipo),
                                            "ascii",
                                            QgsCoordinateReferenceSystem(4326),
                                            "ESRI Shapefile",
                                            True)
    rv = iface.addVectorLayer(path.format(edo, localidad) + '_{}.shp'.format(tipo),
                              '{}_{}'.format(localidad, tipo),
                              "ogr")
    return rv

# Process
tipo = 'manzanas_urbanas_joined'
for localidad in localidades_100k_dictionary.keys():
	localidad_layer(localidad, tipo)
